<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AR Racing Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; overflow: hidden; font-family: sans-serif; background: #000; touch-action: none; }
        canvas { display: block; }
        
        #ar-overlay {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 100;
            display: none;
        }

        #intro-screen {
            position: fixed; inset: 0;
            background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), 
                        url('https://images.unsplash.com/photo-1503376780353-7e6692767b70?auto=format&fit=crop&q=80&w=1000');
            background-size: cover; background-position: center;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 200; color: white; text-align: center; padding: 20px;
        }

        .joy-btn {
            pointer-events: auto; background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px); border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 20px; display: flex; align-items: center; justify-content: center;
            user-select: none; touch-action: none;
        }

        #instructions {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: white; padding: 12px 24px;
            border-radius: 30px; font-weight: bold; white-space: nowrap;
        }

        #error-msg {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: #ef4444; color: white; padding: 15px; border-radius: 10px;
            z-index: 300; display: none; text-align: center; width: 90%;
        }
    </style>
</head>
<body>

    <div id="intro-screen">
        <h1 class="text-4xl font-black italic mb-2">AR RACING PRO</h1>
        <p class="mb-8 text-gray-300">Compatível com Android (Chrome) e navegadores WebXR</p>
        <button id="start-ar" class="bg-red-600 text-white px-10 py-4 rounded-full font-bold text-xl shadow-2xl active:scale-95">
            INICIAR JOGO
        </button>
        <div id="ios-warning" class="mt-6 text-xs text-gray-400 hidden">
            Nota: iOS (Safari) não suporta jogos WebXR nativamente. Usa o Android ou um browser WebXR.
        </div>
    </div>

    <div id="error-msg"></div>

    <!-- Este contentor será a interface durante a AR -->
    <div id="ar-overlay">
        <div id="instructions">Aponta para uma superfície plana</div>
        
        <div id="ui-controls" class="absolute inset-0 pointer-events-none">
            <!-- Direção -->
            <div class="absolute bottom-10 left-10 flex gap-4">
                <div id="btn-left" class="joy-btn w-20 h-20">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="white"><path d="M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6 1.41-1.41z"/></svg>
                </div>
                <div id="btn-right" class="joy-btn w-20 h-20">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="white"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>
                </div>
            </div>
            <!-- Pedais -->
            <div class="absolute bottom-10 right-10 flex gap-4 items-end">
                <div id="btn-brake" class="joy-btn w-20 h-24 flex-col text-[10px] font-bold text-red-300">TRAVAR</div>
                <div id="btn-gas" class="joy-btn w-24 h-32 flex-col text-xs font-bold bg-green-600/20 text-green-300">ACELERAR</div>
            </div>
        </div>
    </div>

    <script>
        const ASSETS = {
            car: 'car.glb',
            track: 'circuito.glb' 
        };

        let scene, camera, renderer, reticle, carModel, trackModel;
        let hitTestSource = null;
        let hitTestSourceRequested = false;
        let isPlaced = false;

        const carState = {
            speed: 0, rotation: 0,
            maxSpeed: 0.04, acceleration: 0.0015, friction: 0.96,
            inputs: { forward: false, backward: false, left: false, right: false }
        };

        // Detetar iOS
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        if (isIOS) document.getElementById('ios-warning').classList.remove('hidden');

        function init() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);
            
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true;
            document.body.appendChild(renderer.domElement);

            const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
            scene.add(light);
            const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
            dirLight.position.set(5, 10, 7);
            scene.add(dirLight);

            // Retícula
            reticle = new THREE.Mesh(
                new THREE.RingGeometry(0.07, 0.1, 32).rotateX(-Math.PI/2),
                new THREE.MeshBasicMaterial()
            );
            reticle.matrixAutoUpdate = false;
            reticle.visible = false;
            scene.add(reticle);

            // Carregar Modelo do Carro
            new THREE.GLTFLoader().load(ASSETS.car, (gltf) => {
                carModel = gltf.scene;
                carModel.scale.set(0.1, 0.1, 0.1);
            });

            setupControls();
        }

        async function startAR() {
            if (!navigator.xr) {
                showError("O seu navegador não suporta WebXR (Realidade Aumentada). No Android use o Chrome.");
                return;
            }

            // FIX: Pedir o mínimo possível para evitar erros de configuração
            const sessionInit = {
                optionalFeatures: ['hit-test', 'dom-overlay'],
                domOverlay: { root: document.getElementById('ar-overlay') }
            };

            try {
                const session = await navigator.xr.requestSession('immersive-ar', sessionInit);
                await renderer.xr.setSession(session);
                
                document.getElementById('intro-screen').style.display = 'none';
                document.getElementById('ar-overlay').style.display = 'block';

                session.addEventListener('end', () => location.reload());

                // Clique para colocar o carro
                renderer.xr.getController(0).addEventListener('select', () => {
                    if (reticle.visible && !isPlaced) {
                        carModel.position.setFromMatrixPosition(reticle.matrix);
                        scene.add(carModel);
                        isPlaced = true;
                        reticle.visible = false;
                        document.getElementById('instructions').innerText = "Conduz o carro!";
                        setTimeout(() => document.getElementById('instructions').style.display = 'none', 3000);
                    }
                });

                renderer.setAnimationLoop(render);
            } catch (e) {
                showError("Erro ao iniciar AR: " + e.message);
            }
        }

        function setupControls() {
            const add = (id, key, val) => {
                const el = document.getElementById(id);
                const start = (e) => { e.preventDefault(); carState.inputs[key] = val; };
                const end = (e) => { e.preventDefault(); carState.inputs[key] = !val; };
                el.addEventListener('pointerdown', start);
                el.addEventListener('pointerup', end);
                el.addEventListener('pointerleave', end);
                el.addEventListener('touchstart', start, {passive: false});
                el.addEventListener('touchend', end, {passive: false});
            };
            add('btn-gas', 'forward', true);
            add('btn-brake', 'backward', true);
            add('btn-left', 'left', true);
            add('btn-right', 'right', true);
        }

        function showError(msg) {
            const el = document.getElementById('error-msg');
            el.innerText = msg;
            el.style.display = 'block';
        }

        function updatePhysics() {
            if (!isPlaced || !carModel) return;
            if (carState.inputs.forward) carState.speed += carState.acceleration;
            else if (carState.inputs.backward) carState.speed -= carState.acceleration;
            else carState.speed *= carState.friction;

            carState.speed = Math.max(-carState.maxSpeed/2, Math.min(carState.maxSpeed, carState.speed));

            if (Math.abs(carState.speed) > 0.001) {
                const turn = carState.speed > 0 ? 1 : -1;
                if (carState.inputs.left) carState.rotation += 0.04 * turn;
                if (carState.inputs.right) carState.rotation -= 0.04 * turn;
            }
            carModel.rotation.y = carState.rotation;
            carModel.translateZ(carState.speed);
        }

        function render(timestamp, frame) {
            if (frame) {
                const refSpace = renderer.xr.getReferenceSpace();
                const session = frame.session;
                if (!hitTestSourceRequested) {
                    session.requestReferenceSpace('viewer').then(ref => {
                        session.requestHitTestSource({ space: ref }).then(src => hitTestSource = src);
                    });
                    hitTestSourceRequested = true;
                }
                if (hitTestSource && !isPlaced) {
                    const results = frame.getHitTestResults(hitTestSource);
                    if (results.length) {
                        const hit = results[0];
                        reticle.visible = true;
                        reticle.matrix.fromArray(hit.getPose(refSpace).transform.matrix);
                    } else {
                        reticle.visible = false;
                    }
                }
            }
            updatePhysics();
            renderer.render(scene, camera);
        }

        init();
        document.getElementById('start-ar').addEventListener('click', startAR);
    </script>
</body>
</html>
