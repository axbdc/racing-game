<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AR Racing Pro - MindAR Fix</title>
    <!-- Bibliotecas MindAR e A-Frame (Versões estáveis) -->
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; overflow: hidden; font-family: sans-serif; background: #000; touch-action: none; }
        
        /* Camada de UI superior */
        #ui-layer {
            position: fixed;
            inset: 0;
            z-index: 1000;
            pointer-events: none;
        }

        #intro-screen {
            position: absolute; inset: 0;
            background: linear-gradient(rgba(0,0,0,0.8), rgba(0,0,0,0.8)), 
                        url('https://images.unsplash.com/photo-1503376780353-7e6692767b70?auto=format&fit=crop&q=80&w=1000');
            background-size: cover; background-position: center;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            pointer-events: auto; color: white; text-align: center; padding: 20px;
        }

        .joy-btn {
            pointer-events: auto; background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px); border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 20px; display: flex; align-items: center; justify-content: center;
            user-select: none; touch-action: none;
        }
        .joy-btn:active { background: rgba(255, 255, 255, 0.5); }

        #ui-controls { position: absolute; inset: 0; display: none; pointer-events: none; }

        #scan-guide {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: white; padding: 12px 24px;
            border-radius: 30px; font-weight: bold; white-space: nowrap; display: none;
        }

        /* Ocultar elementos do A-Frame */
        .a-enter-vr { display: none; }
    </style>
</head>
<body>

    <div id="ui-layer">
        <!-- ECRÃ INICIAL -->
        <div id="intro-screen">
            <h1 class="text-5xl font-black italic mb-2 tracking-tighter text-red-600">MIND AR RACING</h1>
            <p class="mb-8 text-gray-300">Compatível com iOS e Android. Usa o alvo de imagem para jogar.</p>
            <button id="btn-start" class="bg-red-600 text-white px-12 py-5 rounded-full font-bold text-2xl active:scale-95 shadow-2xl mb-4">
                INICIAR JOGO
            </button>
            <p class="text-[10px] opacity-60 max-w-xs uppercase tracking-widest text-white">Tecnologia MindAR - Fix de Buffer Aplicado</p>
        </div>

        <!-- GUIA DE SCAN -->
        <div id="scan-guide">Aponta para o cartão de exemplo</div>

        <!-- CONTROLOS -->
        <div id="ui-controls">
            <!-- Esquerda: Setas -->
            <div class="absolute bottom-10 left-10 flex gap-4">
                <div id="btn-left" class="joy-btn w-20 h-20">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="white"><path d="M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6 1.41-1.41z"/></svg>
                </div>
                <div id="btn-right" class="joy-btn w-20 h-20">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="white"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg>
                </div>
            </div>
            <!-- Direita: Pedais -->
            <div class="absolute bottom-10 right-10 flex gap-6 items-end">
                <div id="btn-brake" class="joy-btn w-24 h-24 flex-col text-xs font-bold text-red-400">TRAVAR</div>
                <div id="btn-gas" class="joy-btn w-28 h-36 flex-col text-sm font-bold bg-green-600/20 text-green-400">GAS</div>
            </div>
        </div>
    </div>

    <!-- CENA AR -->
    <!-- FIX: Usar o link do repositório oficial que é mais estável para o ficheiro .mind -->
    <a-scene 
        mindar-image="imageTargetSrc: https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/card.mind; autoStart: false; uiScanning: no;" 
        embedded color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights" vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">
        
        <a-assets>
            <a-asset-item id="carModel" src="https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/ToyCar/glTF-Binary/ToyCar.glb"></a-asset-item>
        </a-assets>

        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <a-entity mindar-image-target="targetIndex: 0" id="game-anchor">
            <!-- Pista -->
            <a-entity id="track-pivot">
                <a-circle rotation="-90 0 0" radius="1.5" color="#111" opacity="0.9"></a-circle>
                <a-ring rotation="-90 0 0" radius-inner="1.45" radius-outer="1.5" color="red"></a-ring>
            </a-entity>

            <!-- Carro -->
            <a-entity id="car-entity" position="0 0 0">
                <a-entity gltf-model="#carModel" scale="0.15 0.15 0.15" rotation="0 180 0"></a-entity>
            </a-entity>
        </a-entity>
    </a-scene>

    <script>
        // Estado do carro e inputs
        const carState = {
            speed: 0,
            rotation: 0,
            maxSpeed: 0.04,
            acceleration: 0.0015,
            friction: 0.96,
            inputs: { forward: false, backward: false, left: false, right: false }
        };

        const sceneEl = document.querySelector('a-scene');
        const carEntity = document.querySelector('#car-entity');
        const anchor = document.querySelector('#game-anchor');
        const uiControls = document.querySelector('#ui-controls');
        const scanGuide = document.querySelector('#scan-guide');

        // Inicialização manual para evitar conflitos de carregamento
        document.getElementById('btn-start').addEventListener('click', () => {
            document.getElementById('intro-screen').style.display = 'none';
            scanGuide.style.display = 'block';
            
            // Tentar iniciar o sistema MindAR
            const arSystem = sceneEl.systems["mindar-image-system"];
            if (arSystem) {
                arSystem.start();
            } else {
                console.error("Sistema MindAR não encontrado.");
            }
        });

        // Feedback visual do tracking
        anchor.addEventListener("targetFound", () => {
            scanGuide.style.display = 'none';
            uiControls.style.display = 'block';
        });

        anchor.addEventListener("targetLost", () => {
            uiControls.style.display = 'none';
            scanGuide.style.display = 'block';
        });

        // Mapeamento de controlos táteis
        const setupButton = (id, key, val) => {
            const btn = document.getElementById(id);
            const start = (e) => { e.preventDefault(); carState.inputs[key] = val; };
            const end = (e) => { e.preventDefault(); carState.inputs[key] = !val; };
            btn.addEventListener('pointerdown', start);
            btn.addEventListener('pointerup', end);
            btn.addEventListener('pointerleave', end);
        };

        setupButton('btn-gas', 'forward', true);
        setupButton('btn-brake', 'backward', true);
        setupButton('btn-left', 'left', true);
        setupButton('btn-right', 'right', true);

        // Componente de lógica de condução
        AFRAME.registerComponent('car-logic', {
            tick: function (time, timeDelta) {
                // Só processa física se o alvo estiver visível
                if (uiControls.style.display === 'none') return;

                // Aceleração e Travagem
                if (carState.inputs.forward) carState.speed += carState.acceleration;
                else if (carState.inputs.backward) carState.speed -= carState.acceleration;
                else carState.speed *= carState.friction;

                // Limite de velocidade
                carState.speed = Math.max(-carState.maxSpeed/2, Math.min(carState.maxSpeed, carState.speed));

                // Rotação (Direção)
                if (Math.abs(carState.speed) > 0.001) {
                    const turnDir = carState.speed > 0 ? 1 : -1;
                    if (carState.inputs.left) carState.rotation += 3 * turnDir;
                    if (carState.inputs.right) carState.rotation -= 3 * turnDir;
                }

                // Aplicar rotação ao modelo
                carEntity.setAttribute('rotation', { x: 0, y: carState.rotation, z: 0 });

                // Calcular nova posição baseada no ângulo
                const angleRad = (carState.rotation * Math.PI) / 180;
                const pos = carEntity.getAttribute('position');
                
                const nextX = pos.x + Math.sin(angleRad) * carState.speed;
                const nextZ = pos.z + Math.cos(angleRad) * carState.speed;

                // Verificação de colisão com a borda (raio de 1.45m)
                const distance = Math.sqrt(nextX*nextX + nextZ*nextZ);
                if (distance < 1.45) {
                    carEntity.setAttribute('position', { x: nextX, y: 0, z: nextZ });
                } else {
                    carState.speed *= -0.5; // Ricochete simples
                }
            }
        });

        // Adicionar o componente ao carro
        carEntity.setAttribute('car-logic', '');
    </script>
</body>
</html>
